ESP-IDF es el **SDK** oficial de la familia de **ESPRESSIF**. El Sistema de Construcción que utiliza es CMake, y su programa maestro es **idf.py**, guía completa de herramientas en [[1. EMBEDDED/2. MCU/1. FIRMWARE/1. SDK/1. ESP - IDF/2. TOOLS (CLI)|2. TOOLS (CLI)]], guia completa de configuraciones usuales en [[3. MENUCONFIG]].

---
### PROJECT
La **estructura** de proyecto es **modular**, se trabaja por componentes. Al crear un proyecto se crea por defecto el componente main, es el principal, los demás irán bajo la carpeta components. 

---
#### STRUCTURE
La estructura de un proyecto es:

```
my_project/
├── .vscode/                    <- (opcional, para el ruteo del Intellisence)
├── build/                      <- Archivos de Compilación
│
├── main/                       
│   ├── main.c                  <- Punto de entrada de la aplicación
│   └── CMakeLists.txt          <- Resolucion de Dependencias del Componente
│
├── components/                 
│   └── my_component/
│       └── include/            <- Headers Files
│           └── my_component.h
│       └── src/                <- Source Files
│           └── my_component.h
│       └── CMakeLists.txt      <- Resolucion de Dependencias del Componente
│
├── CMakeLists.txt              <- CMake principal del proyecto
├── partitions.cvs              <- Partitions File
├── sdkconfig                   <- Config (menuconfig)
├── sdkconfig.old               <- Backup (menuconfig)
│
```

---
#### PORTABLE
Un **proyecto** es completamente **portable**, 

- **Configuracion**: Completamente descrita en el **sdkconfig**
- **Entrada del SDK**: Descrita en el **CMakeLists.txt** principal, con algunos metadatos
- **Dependencias**: Entre componentes, declaradas en los **CMakeLists.txt** de cada componente.

Un proyecto se suele crear mediante cli (create-project), pero tambien puede ser portado, luego de copiar el proyecto, se debe ejecutar

```
idf.py fullclean
idf.py build
```

---
#### SDK CONFIG
El **sdkconfig** se altera mediante cli (menuconfig), pudiendo cambiar el tamaño de flash, macros config del framework oficial, y customizar las particiones [[3. MENUCONFIG#^4ef61f]].

La estructura del **partitions.cvs**

```
# Name,       Type, SubType, Offset,   Size
nvs,          data, nvs,     0x9000,   0x6000
phy_init,     data, phy,     0xf000,   0x1000
factory,      app,  factory, 0x10000,  0x3F0000
```

---
### COMPONENTS
Un componente engloba todo los archivos dentro de su carpeta, su **CMakeLists.txt** debe rutear estos archivos, y resolver sus dependencias con otros componentes, tiene la forma:

```
idf_component_register(SRC_DIRS     src
                       INCLUDE_DIRS "include"
                       REQUIRES     component_1 component_2)
```

Durante compilacion un componente se reduce a un solo binario libComponent.a.

Los unicos componentes que no necesitan ser requeridos para su uso, y siempre podemos incluir son los de FreeRTOS. Todos los demas deberán ser añadidos manualmente

---
#### PORTABLE
Un **componente** es completamente **portable**, esta completamente contenido en su carpeta, y resuelto por su **CMakeLists.txt**.

---
#### EXPLANATION
El **idf.py** resuelve las dependencias buscando una carpeta con el nombre del componente en 3 lugares posibles

```
├── Componentes del Framework, en la carpeta components del esp-idf
	ruta default ~/esp/esp-idf/components/

├── Componentes del Proyecto
	ruta my-project-path/components
	
├── Componentes agregados como dependencias por paqueteria de espressif
	ruta my-project-path/.dependencies (no recomendado)
```

*Como adicional se pueden revisar las utilidades de los archivos KCONFIG y component.yml para mas funcionalidades de espressif.

---
### INTELLISENCE
Al trabajar con un nuevo **SDK** es necesario el ruteo del motor de intellisence. Siguiendo el formato descrito en [[1. INTELLISENCE#^4b5245]] (COMPILE COMMANDS), las rutas en Linux son:

```
<compile-commands-path> = ${workspaceFolder}/build/compile_commands.json
<compiler-path> = ${env:HOME}/.espressif/tools/xtensa-esp-elf/esp-14.2.0_20241119/xtensa-esp-elf/bin/xtensa-esp32-elf-gcc
<other-include-path> = ${env:HOME}/esp/esp-idf/components/**
<compiler-intellisence-mode> = gcc-x64
<version> = 17
```

El compile_commands.json, en esp-idf se genera con:

```
idf.py reconfigure -DCMAKE_EXPORT_COMPILE_COMMANDS=1
```

Que genera el archivo en build/compile_commands.json. Debe ser regenerado cada que se hagan cambios estructurales en el proyecto, como añadir archivos y/o componentes.

---
### LECTURES
- [[1. WORK-FLOW (SDK)]]
- https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/linux-macos-setup.html
